import os
import io
from flask import Flask, request, render_template, redirect, url_for, flash
import numpy as np

from cnn_utils import load_all_models, get_cnn_fuzzy_score, SKOR_LOGIC_SERTIFIKAT, SKOR_LOGIC_RUMAH
from fuzzy_system import sistem_fuzzy_beasiswa

app = Flask(__name__)
app.secret_key = 'kunci_rahasia_spk_beasiswa' 

MODEL_SERTIFIKAT = 'models/model_cnn_sertifikat.h5'
MODEL_RUMAH = 'models/model_cnn_rumah.h5'

print("Memuat model CNN, harap tunggu...")
if not os.path.exists(MODEL_SERTIFIKAT) or not os.path.exists(MODEL_RUMAH):
    print("="*50)
    print("ERROR: File model .h5 tidak ditemukan di folder /models/")
    print("Harap jalankan cnn_trainer.py terlebih dahulu!")
    print("="*50)
    models_loaded_status = False
    model_sertifikat, model_rumah, kelas_sertifikat, kelas_rumah = None, None, None, None
else:
    model_sertifikat, model_rumah, kelas_sertifikat, kelas_rumah = load_all_models(
        MODEL_SERTIFIKAT, MODEL_RUMAH
    )
    models_loaded_status = True
    print("Model CNN berhasil dimuat. Server Flask siap.")


@app.route('/', methods=['GET', 'POST'])
def index():
    if not models_loaded_status:
        return "ERROR: Model CNN tidak dapat dimuat. Periksa terminal untuk detail.", 500

    if request.method == 'POST':
        if 'file_sertifikat' not in request.files or 'file_rumah' not in request.files:
            flash("Kesalahan: Kedua file gambar (Sertifikat dan Rumah) harus diunggah.")
            return redirect(request.url)

        file_sertifikat = request.files['file_sertifikat']
        file_rumah = request.files['file_rumah']

        if file_sertifikat.filename == '' or file_rumah.filename == '':
            flash("Kesalahan: Harap pilih kedua file gambar.")
            return redirect(request.url)

        try:
            ipk = float(request.form['ipk'])
            penghasilan_ortu = int(request.form['penghasilan_ortu'])
        except ValueError:
            flash("Kesalahan: IPK atau Penghasilan harus berupa angka yang valid.")
            return redirect(request.url)

        skor_cnn_prestasi = get_cnn_fuzzy_score(
            file_sertifikat, model_sertifikat, kelas_sertifikat, SKOR_LOGIC_SERTIFIKAT
        )
        skor_cnn_finansial = get_cnn_fuzzy_score(
            file_rumah, model_rumah, kelas_rumah, SKOR_LOGIC_RUMAH
        )

        skor_akhir = sistem_fuzzy_beasiswa(
            ipk_val=ipk,
            penghasilan_val=penghasilan_ortu,
            skor_cnn_sertifikat_val=skor_cnn_prestasi,
            skor_cnn_rumah_val=skor_cnn_finansial
        )

        rekomendasi_teks = "Prioritas RENDAH"
        rekomendasi_level = "rendah" 
        if skor_akhir >= 85:
            rekomendasi_teks = "Prioritas SANGAT TINGGI"
            rekomendasi_level = "sangat-tinggi"
        elif skor_akhir >= 65:
            rekomendasi_teks = "Prioritas TINGGI"
            rekomendasi_level = "tinggi"
        elif skor_akhir >= 40:
            rekomendasi_teks = "Prioritas SEDANG"
            rekomendasi_level = "sedang"

        return render_template(
            'index.html',
            skor_akhir=f"{skor_akhir:.2f}",
            rekomendasi_teks=rekomendasi_teks,
            rekomendasi_level=rekomendasi_level,
            ipk_in=ipk,
            penghasilan_in=penghasilan_ortu,
            skor_cnn_prestasi=f"{skor_cnn_prestasi:.2f}",
            skor_cnn_finansial=f"{skor_cnn_finansial:.2f}"
        )
    return render_template('index.html', skor_akhir=None)


if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)